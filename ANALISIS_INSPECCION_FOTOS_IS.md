# üîç AN√ÅLISIS: Inspecci√≥n Vehicular con Fotos - INTERNACIONAL

**Fecha:** Octubre 31, 2025  
**Estado:** ‚ö†Ô∏è NO IMPLEMENTADO - Requiere Informaci√≥n

---

## üéØ SITUACI√ìN ACTUAL

### ‚úÖ LO QUE TENEMOS:

**Componente de Inspecci√≥n:**
- `/components/cotizadores/VehicleInspection.tsx`
- Captura 10 fotos del veh√≠culo:
  1. Vista Frontal
  2. Vista Trasera
  3. Lateral Izquierdo
  4. Lateral Derecho
  5. Registro Vehicular
  6. Motor Abierto
  7. Asientos
  8. Kilometraje
  9. Llave del Veh√≠culo
  10. Tablero

**Formato de captura:**
```typescript
interface InspectionPhoto {
  id: string;          // Ej: 'frontal', 'trasera'
  name: string;        // Ej: 'Vista Frontal'
  file: File;          // Archivo de imagen
  preview: string;     // Base64 para preview
}
```

**Flujo ACTUAL de emisi√≥n:**
```
Step 1: Seleccionar plan de pago
  ‚Üì
Step 2: Completar datos de emisi√≥n
  ‚Üì
Step 3: Capturar fotos de inspecci√≥n ‚Üê AQU√ç SE CAPTURAN
  ‚Üì
Step 4: Informaci√≥n de pago (tarjeta)
  ‚Üì
Step 5: Revisar y confirmar
  ‚Üì
Step 6: Emitir p√≥liza
```

---

## ‚ùå EL PROBLEMA

**Las fotos NO se env√≠an a INTERNACIONAL:**

En `/app/cotizadores/emitir/page.tsx` l√≠neas 107-129:
```typescript
// Emisi√≥n con API de INTERNACIONAL
const emisionResponse = await fetch('/api/is/auto/emitir', {
  body: JSON.stringify({
    vIdPv: selectedPlan._idCotizacion,
    vnrodoc: emissionData?.cedula,
    // ... otros datos
    paymentToken,
    // ‚ùå NO SE ENV√çAN LAS FOTOS
  }),
});
```

**Las fotos se capturan pero se guardan solo en estado local:**
```typescript
const [inspectionPhotos, setInspectionPhotos] = useState<any[]>([]);
// ‚Üë Nunca se usan en la emisi√≥n
```

---

## ‚ùì PREGUNTAS CR√çTICAS

### 1. ¬øINTERNACIONAL tiene API para subir fotos?

**Posibles escenarios:**

**A. S√ç tienen API de upload:**
```
POST /api/upload/documentos
{
  idCotizacion: "xxx",
  tipo: "inspeccion_vehicular",
  fotos: [
    { tipo: "frontal", archivo: base64 },
    { tipo: "trasera", archivo: base64 },
    ...
  ]
}
```

**B. Las fotos se env√≠an en la emisi√≥n:**
```
POST /api/cotizaemisorauto/getemision
{
  vIdPv: "xxx",
  // ... otros datos
  fotos: [base64Array]
}
```

**C. NO tienen API - Manual:**
- Las fotos se guardan solo en nuestro sistema
- INTERNACIONAL las solicita por email/portal
- Proceso manual posterior

---

### 2. ¬øEn qu√© formato aceptan las fotos?

**Opciones:**
- Base64 en JSON
- FormData multipart/form-data
- URLs de archivos subidos previamente
- Formato propietario de IS

---

### 3. ¬øCu√°ndo se deben subir?

**Opciones:**
- **Antes de cotizar** (para validar condici√≥n del veh√≠culo)
- **Antes de emitir** (durante el flujo de emisi√≥n)
- **Despu√©s de emitir** (como anexo a la p√≥liza)

---

## üîç LO QUE NECESITAMOS VERIFICAR

### PASO 1: Revisar documentaci√≥n de IS

**Buscar en la documentaci√≥n:**
- ¬øExiste endpoint de upload de fotos/documentos?
- ¬øQu√© formato acepta?
- ¬øQu√© campos son requeridos?
- ¬øHay l√≠mite de tama√±o/cantidad?
- ¬øRetorna alg√∫n ID de referencia?

---

### PASO 2: Consultar con INTERNACIONAL

**Preguntas espec√≠ficas:**

1. **¬øTienen API para subir fotos de inspecci√≥n vehicular?**
   - S√≠ / No

2. **Si S√ç, ¬øcu√°l es el endpoint?**
   - URL completa
   - M√©todo (POST, PUT)

3. **¬øQu√© formato de datos acepta?**
   - JSON con base64
   - FormData multipart
   - Otro

4. **¬øCu√°ndo se deben subir las fotos?**
   - Antes de cotizar
   - Antes de emitir
   - Despu√©s de emitir

5. **¬øQu√© datos adicionales requiere cada foto?**
   - ID de cotizaci√≥n
   - Tipo de foto (frontal, trasera, etc.)
   - Marca/modelo del veh√≠culo
   - Otros metadatos

6. **¬øHay validaciones?**
   - Tama√±o m√°ximo por foto
   - Cantidad m√°xima de fotos
   - Formatos permitidos (JPG, PNG, HEIC)

7. **¬øRetorna alg√∫n ID o confirmaci√≥n?**
   - ID de documento
   - URL de acceso
   - Confirmaci√≥n de recepci√≥n

---

## üìã IMPLEMENTACIONES POSIBLES

### ESCENARIO A: IS tiene API de Upload

**Si INTERNACIONAL tiene API para subir fotos:**

#### 1. Crear servicio de upload

**Archivo:** `/lib/is/upload.service.ts`

```typescript
export interface UploadFotoRequest {
  idCotizacion: string;
  tipoFoto: string; // 'frontal', 'trasera', etc.
  archivo: string;  // Base64
  nombreArchivo: string;
}

export async function subirFotoInspeccion(
  request: UploadFotoRequest,
  env: ISEnvironment
): Promise<{ success: boolean; idDocumento?: string; error?: string }> {
  // TODO: Usar endpoint real de IS
  const response = await isPost(
    '/api/upload/inspeccion', // Endpoint a confirmar
    {
      id_cotizacion: request.idCotizacion,
      tipo_documento: 'INSPECCION_VEHICULAR',
      tipo_foto: request.tipoFoto,
      archivo_base64: request.archivo,
      nombre_archivo: request.nombreArchivo,
    },
    env
  );
  
  return {
    success: response.success,
    idDocumento: response.data?.id_documento,
    error: response.error,
  };
}
```

#### 2. Modificar flujo de emisi√≥n

**En `/app/cotizadores/emitir/page.tsx`:**

```typescript
const handleConfirmEmission = async () => {
  // 1. Subir fotos ANTES de emitir
  toast.loading('Subiendo fotos de inspecci√≥n...');
  
  const uploadPromises = inspectionPhotos.map(async (photo) => {
    // Convertir File a Base64
    const base64 = await fileToBase64(photo.file);
    
    return subirFotoInspeccion({
      idCotizacion: selectedPlan._idCotizacion,
      tipoFoto: photo.id,
      archivo: base64,
      nombreArchivo: photo.file.name,
    });
  });
  
  const uploadResults = await Promise.all(uploadPromises);
  
  const failed = uploadResults.filter(r => !r.success);
  if (failed.length > 0) {
    toast.error(`Error subiendo ${failed.length} foto(s)`);
    return;
  }
  
  toast.success('Fotos subidas correctamente');
  
  // 2. Emitir p√≥liza normalmente
  const emisionResponse = await fetch('/api/is/auto/emitir', {
    // ... resto del c√≥digo
  });
};
```

#### 3. Crear endpoint API

**Archivo:** `/app/api/is/upload/inspeccion/route.ts`

```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();
  
  const {
    idCotizacion,
    tipoFoto,
    archivoBase64,
    nombreArchivo,
    environment = 'development',
  } = body;
  
  // Validaciones
  if (!idCotizacion || !archivoBase64) {
    return NextResponse.json(
      { success: false, error: 'Faltan datos requeridos' },
      { status: 400 }
    );
  }
  
  // Subir a API de IS
  const result = await subirFotoInspeccion({
    idCotizacion,
    tipoFoto,
    archivo: archivoBase64,
    nombreArchivo,
  }, environment);
  
  return NextResponse.json(result);
}
```

---

### ESCENARIO B: NO tienen API - Guardar en Supabase

**Si INTERNACIONAL NO tiene API, guardamos en nuestro sistema:**

#### 1. Guardar en Supabase Storage

```typescript
import { supabaseClient } from '@/lib/supabase/client';

async function guardarFotosInspeccion(
  policyId: string,
  fotos: InspectionPhoto[]
): Promise<string[]> {
  const uploadedUrls: string[] = [];
  
  for (const foto of fotos) {
    const fileName = `${policyId}/${foto.id}-${Date.now()}.jpg`;
    
    // Subir a Supabase Storage
    const { data, error } = await supabaseClient
      .storage
      .from('inspection-photos')
      .upload(fileName, foto.file, {
        contentType: 'image/jpeg',
      });
    
    if (error) {
      console.error(`Error subiendo ${foto.name}:`, error);
      continue;
    }
    
    // Obtener URL p√∫blica
    const { data: urlData } = supabaseClient
      .storage
      .from('inspection-photos')
      .getPublicUrl(fileName);
    
    uploadedUrls.push(urlData.publicUrl);
  }
  
  return uploadedUrls;
}
```

#### 2. Guardar referencias en BD

```typescript
// Crear tabla inspection_photos
await supabase
  .from('inspection_photos')
  .insert({
    policy_id: policyId,
    photo_type: foto.id,
    photo_url: url,
    uploaded_at: new Date().toISOString(),
  });
```

#### 3. Enviar por email a IS

```typescript
// Generar email con enlaces
const emailBody = `
  Inspecci√≥n vehicular para p√≥liza ${policyNumber}:
  
  Fotos disponibles en:
  ${uploadedUrls.map(url => `- ${url}`).join('\n')}
`;

// Enviar via Zoho o servicio de email
```

---

## üîÑ FLUJO PROPUESTO

### OPCI√ìN 1: Con API de IS

```
Usuario captura 10 fotos
  ‚Üì (guardan en estado local)
Usuario confirma emisi√≥n
  ‚Üì
LOOP: Por cada foto
  ‚îú‚îÄ Convertir a Base64
  ‚îú‚îÄ POST /api/is/upload/inspeccion
  ‚îî‚îÄ Retorna: { idDocumento }
  ‚Üì
POST /api/is/auto/emitir
  ‚îú‚îÄ vIdPv
  ‚îú‚îÄ ...otros datos
  ‚îî‚îÄ idsDocumentos: [id1, id2, ..., id10]
  ‚Üì
‚úÖ P√≥liza emitida con fotos vinculadas
```

---

### OPCI√ìN 2: Sin API de IS

```
Usuario captura 10 fotos
  ‚Üì
Usuario confirma emisi√≥n
  ‚Üì
POST /api/is/auto/emitir (sin fotos)
  ‚Üì
‚úÖ P√≥liza emitida ‚Üí Retorna policyId
  ‚Üì
LOOP: Por cada foto
  ‚îú‚îÄ Upload a Supabase Storage
  ‚îú‚îÄ INSERT en tabla inspection_photos
  ‚îî‚îÄ Retorna: URL p√∫blica
  ‚Üì
Enviar email a IS con URLs
  ‚Üì
‚úÖ Fotos disponibles para revisi√≥n manual
```

---

## üìä COMPARACI√ìN

| Aspecto | Con API de IS | Sin API de IS |
|---------|--------------|---------------|
| Integraci√≥n | ‚úÖ Directa | ‚ö†Ô∏è Manual |
| Velocidad | ‚úÖ Autom√°tica | ‚è≥ Requiere revisi√≥n |
| Validaci√≥n | ‚úÖ Inmediata | ‚ùå Posterior |
| Almacenamiento | ‚úÖ En IS | ‚ö†Ô∏è En Supabase |
| Mantenimiento | ‚úÖ Simple | ‚ö†Ô∏è Complejo |

---

## ‚úÖ RECOMENDACIONES

### PRIORIDAD ALTA:

1. **Contactar a INTERNACIONAL**
   - Preguntar si tienen API de upload
   - Solicitar documentaci√≥n

2. **Si tienen API:**
   - Implementar servicio de upload
   - Modificar flujo de emisi√≥n
   - Probar con fotos reales

3. **Si NO tienen API:**
   - Guardar en Supabase
   - Crear proceso de env√≠o manual
   - Documentar workflow

---

## üöÄ PR√ìXIMOS PASOS

1. ‚úÖ Analizar componente de inspecci√≥n actual
2. ‚è≥ **Contactar a INTERNACIONAL** - Preguntar sobre API de fotos
3. ‚è≥ **Obtener documentaci√≥n** - Si existe el endpoint
4. ‚è≥ **Implementar integraci√≥n** - Seg√∫n respuesta
5. ‚è≥ **Probar flujo completo** - Con fotos reales

---

## üìù PREGUNTAS PARA INTERNACIONAL

**Enviar este email a INTERNACIONAL:**

```
Asunto: Consulta - API de Upload de Fotos de Inspecci√≥n Vehicular

Estimados,

Estamos integrando su API de cotizaci√≥n y emisi√≥n de seguros auto 
(cobertura completa) y necesitamos confirmar el proceso para las 
fotos de inspecci√≥n vehicular.

Preguntas:

1. ¬øTienen un endpoint API para subir fotos de inspecci√≥n?
   - Si es as√≠, ¬øcu√°l es el endpoint?

2. ¬øEn qu√© momento del flujo se deben subir?
   - Antes de cotizar
   - Antes de emitir
   - Despu√©s de emitir

3. ¬øQu√© formato de datos acepta?
   - Base64 en JSON
   - FormData multipart
   - Otro

4. ¬øQu√© informaci√≥n adicional se requiere por foto?
   - ID de cotizaci√≥n
   - Tipo de foto (frontal, trasera, etc.)
   - Otros metadatos

5. ¬øHay l√≠mites t√©cnicos?
   - Tama√±o m√°ximo por foto
   - Cantidad m√°xima de fotos
   - Formatos permitidos

Adjunto lista de las 10 fotos que capturamos:
- Vista Frontal
- Vista Trasera
- Lateral Izquierdo
- Lateral Derecho
- Registro Vehicular
- Motor Abierto
- Asientos
- Kilometraje
- Llave del Veh√≠culo
- Tablero

Agradecemos su pronta respuesta.
```

---

## üéØ CONCLUSI√ìN

**Estado Actual:** ‚ö†Ô∏è Las fotos se capturan pero NO se env√≠an a INTERNACIONAL

**Acci√≥n Requerida:** Contactar a INTERNACIONAL para confirmar:
- ¬øTienen API de upload?
- ¬øC√≥mo funciona?

**Tiempo de implementaci√≥n:**
- Con API de IS: 2-3 horas
- Sin API de IS: 3-4 horas

**Estado:** ‚è≥ ESPERANDO INFORMACI√ìN DE INTERNACIONAL
