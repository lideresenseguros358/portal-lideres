# Auditoría módulo Cheques

## Prompt original

> como hicimos con comisiones, quiero que ahora la pagina cheques hagamos una auditoria completa de todo el flujo de trabajo, cada archivo, cada tabla que necesita y lo que hay en database, cada rls, cada trigger, cada endpoint, TODO revisalo y haz los ajustes necesarios para que el flujo funcione 100%. Cheques —  Flujo de trabajo funcional completo  (sin crear tablas/cols nuevas)     Objetivo del módulo: centralizar la conciliación bancaria (histórico del banco) y la aplicación de fondos a pagos (aseguradoras, devoluciones a clientes, adelantos a corredores, trámites), con control de referencias, estados y pruebas de uso (PDF). Todo mobile-first, consistente con el branding y reutilizando componentes (labels, chips, botones) como en Cheques/Pendientes/Comisiones.         0) Alcance y lineamientos     Rol: MASTER. No inventar tablas: usar las que ya existen en database (check_* o equivalentes), trámites, comisiones/advances, vistas/helpers. Estados visuales se derivan por lógica (verde/gris/amarillo/rojo/azul); no agregar columnas persistentes para estados. Regla de oro: nada se “paga/aplica” si la referencia bancaria no está conciliada correctamente (ROJO = bloqueado).           1) Importar histórico del banco (entrada de datos “verdad”)     Fuente: archivo del banco (CSV/XLSX). Extracción exacta (column mapping):   Fecha → fecha (obligatoria) Referencia → ref (secundaria, informativa) Referencia 1 → ref1 (ID único principal de la transferencia; clave de match) Referencia 2 → comentario (guardar literal como comentario) Referencia 3 → (ignorar) Referencia 4 → (ignorar) Transacción → (ignorar) Descripción → descripcion (limpia prefijos: eliminar “BANCA MOVIL TRANSFERENCIA DE ”, “ACH - ”, “BANCA EN LINEA TRANSFERENCIA A ”, “ACH EXPRESS - ”; quita doble espacio / espacios invisibles; deja el resto) Débito → (ignorar) Crédito → monto (positivo; NO confundir con Débito) Saldo Total → (ignorar)     Validaciones de import:   ref1 no nulo y único (no permitir duplicados en archivo; tampoco duplicar contra lo ya importado). fecha válida (ISO). monto > 0 con 2 decimales. Preview con filas problemáticas en ROJO (duplicado, monto vacío, fecha inválida) → bloquean “Confirmar”.     Al confirmar:   Upsert por ref1 (no duplica lo existente). Calcula estado inicial: Gris si tiene posibles matches en pendientes por monto o por “intención de uso” (ver §5). Amarillo si sin clasificar ≤30 días. Rojo si sin clasificar >30 días o si hay pagos “forzados” que hacen referencia a un ref1 inexistente (ver §7.4). Azul si aplazado manualmente. Verde se alcanzará al asignar 100% el monto (saldo remanente 0) a pagos válidos.             2) Historial (consulta/conciliación)     Objetivo: ver movimientos importados y su estado de conciliación.   Listado:   Columnas: Fecha, Referencia (muestra ref1 y ref), Descripción limpia, Monto (Crédito), Estado (chip), Acciones. Acciones rápidas por fila: Ver vínculos: modal con desglose de aplicaciones (pagos/partidas asignadas), y remanente (monto – Σ asignaciones). Aplazar +30d: pasa el movimiento a Azul (con nota/fecha reactivación). Resolver: abre el asistente para aplicar este ref1 a pagos pendientes (ver §5).       Estados (derivación):   Verde (aplicado): remanente = 0 (asignado 100% a pagos). Gris (match listo): existe al menos un pendiente “habilitado” para este ref1 (coincidencia verificada), quedan por asignar montos. Amarillo (sin clasificar 15–30d): no tiene matches ni aplicaciones. Rojo (bloqueo): Llega >30 días sin clasificar, o Existe “pago pendiente” que referencia un ref1 que no está en histórico (pago forzado). → Con ROJO no se permite pagar (botones de pago deshabilitados).   Azul (aplazado): pospuesto; retorna a Gris/Amarillo según corresponda al vencer la reactivación.           3) Pagos pendientes (bandeja operativa)     Objetivo: registrar y mantener intenciones de pago que aún no han sido cubiertas por una referencia bancaria válida.   Crear pendiente de pago (dos escenarios):   Pendiente con ref1: el usuario ingresa ref1 que aún no está en histórico → el card queda en ROJO (“no habilitado”) Cuando ese ref1 aparezca en el próximo import del banco, el pendiente pasa automáticamente a GRIS habilitado. ·  ·  Pendiente sin ref1: se crea con ROJO (no habilitado). Se habilitará cuando: se asigne un ref1 existente en histórico, o provenga de descuento en Comisiones (ver §6.2), en cuyo caso se habilita sin ref (color GRIS especial) porque ya fue cubierto por quincena.   ·      Al habilitar (cambios automáticos):   El pendiente queda seleccionable para: Exportar PDF de pagos (para ejecutar en el banco), y Marcar pagado (cuando se confirma que se hizo en banco).       PDF de pendientes:   Se genera un PDF con los seleccionados (branding, totales y desglose por tipo). El PDF no cambia estados; sirve para ejecutar y como soporte.     Confirmar pagado (post-ejecución en banco):   Se seleccionan los mismos pendientes y se pulsa “Pagado”: Si tienen ref1, se vinculan definitivamente al movimiento del histórico y pasan a VERDE (aplicado). Si no tienen ref1 por ser descuento de comisiones (ver §6.2), también pasan a VERDE con un asiento pseudo-bancario en histórico (ver §6.2 “asiento espejo”).   El modal de detalle del pago queda disponible en cada card (con Editar/Eliminar): Editar: ajusta datos (monto/nota/destino) y re-calcula vinculación. Eliminar: deshace la aplicación, vuelve a GRIS (si tiene ref1) o ROJO (si no tiene). Si era “descuento de comisiones”, revierte la marca “aplicado” del asiento espejo (sin tocar Comisiones).             4) Tipos de pago soportados (y parámetros)     Un ref1 puede dividirse en varios pagos (“split”) y varios ref1 pueden sumarse para un pago único (“merge”). Los flujos se soportan en Aplicar a pagos.   Pagos a Aseguradoras   Requiere: Aseguradora, N° de póliza, monto. Se sugiere desde Pendientes cuando proviene de Trámite “pagar aseguradora”.     Devoluciones   Devolución a corredor: Requiere: seleccionar broker (dropdown), monto.   Devolución a cliente: Requiere: nombre del cliente y bank_json completo: número de cuenta, tipo de cuenta, banco, titular (debe coincidir con el nombre).     Parciales: permitido. Resta saldo y deja remanente.     Aplicar “split” y “merge”   Split (1 ref → N pagos): Seleccionas ref1 → agregas varias líneas (aseguradora/cliente/corredor) hasta agotar el monto.   Merge (N ref → 1 pago): Seleccionas múltiples ref1 con saldos → un registro de pago. Quedan varias aplicaciones que suman al mismo pago lógico (controlado por el wizard).             5) Aplicar una referencia a pagos (asistente)     Entrada: seleccionar ref1 pendiente (no-verde). Panel izquierdo: Remanente (monto – Σ asignaciones). Panel derecho: Pagos pendientes (filtrables):   Origen: Trámites (pagar aseguradora / devolución / pago directo / descontar a corredor), Manual (creados en Cheques), Comisiones → Adelantos (sugeridos; ver §6.1).   Cada línea muestra: tipo, referencias relacionadas, monto solicitado, broker/cliente/aseguradora, notas. Al agregar una aplicación: Se abre modal de detalle según tipo (ver §4). Guarda y descarga del remanente. Botón “+” permite encadenar más líneas sin cerrar.       Reglas:   Remanente nunca negativo. Puedes dejar remanente > 0: el ref1 seguirá GRIS hasta completar. Al llegar a 0 → VERDE (conciliado). Rojo no paga (si el pendiente es rojo por ref inexistente, no permite aplicar).             6) Integración con Comisiones / Pendientes (casos especiales)       6.1 Adelantos (Comisiones) → Pago externo     Desde Comisiones / Nueva quincena / Adelantos, acción “Pago externo” abre el mismo modal “Registrar transferencia” de Cheques: Crea el ref1 en histórico con intención de uso hacia ese adelanto (badge “Sugerido” en Aplicar). Se aplica parcial/total en §5. El adelanto no se marca pagado hasta que la aplicación quede VERDE (saldo 0 o saldo aplicado suficiente).         6.2 Descuento en quincena (sin ref1)     En Comisiones, al cerrar una quincena, se descuentan adelantos del broker. En Cheques debe existir un asiento espejo para el historial con: Fecha = fecha de cierre de la quincena, Referencia = literal “DESCUENTO COMISIONES”, Descripción = “Broker: {nombre} — Quincena: {Qx-MM-YYYY}”, Monto = total descontado.   Este asiento habilita el pago pendiente respectivo (GRIS) sin ref1 (excepción autorizada). Al marcar pagado en Cheques: Se confirma el asiento espejo → VERDE para esos pendientes. No se toca Comisiones (Comisiones ya cerró); Cheques solo asienta la contrapartida bancaria/contable.       Si un pendiente tenía “Descontar a corredor” pero antes de cerrar quincena el corredor transfirió, en Pendientes se cambia a “Transferencia recibida”:   Exige ref1. Elimina automáticamente el adelanto generado y el pago pendiente previo de descuento. El flujo continúa como transferencia normal: quedará ROJO hasta que ref1 aparezca en histórico; cuando aparezca, pasa a GRIS y puede aplicarse.         6.3 Pago directo a aseguradora (Pendientes)     En Pendientes si el broker indica “Pago directo”: Eliminar automáticamente el adelanto (si existía) y el pago pendiente de Cheques asociado. Se registra la evidencia en el trámite y no llega a Cheques.             7) Edición / Reversión / Auditoría     Modal de movimiento aplicado (desde Histórico o Pagos): muestra detalle y permite: Editar (monto/nota/datos bancarios en devoluciones) → recalcula remanente/estado. Eliminar aplicación → vuelve a GRIS (o ROJO si no hay ref1).   Bitácora: altas, ediciones, aplicaciones, aplazos, exportaciones; consultable por ref1 y fecha. Panel “Validaciones abiertas”: Lista ROJOS (>30 días sin clasificar o forzados) con botón “Ir a resolver”.             8) Exportación PDF (prueba de uso)     A partir de Pagos pendientes (habilitados), checklist → Exportar PDF: Un único PDF con todas las partidas: Fecha, Referencia, Tipo, Aseguradora/Cliente/Póliza/Broker, Monto, Estado, Notas. Si es devolución, bloque adicional con bank_json. Totales al pie (y subtotales por tipo si se marcaron múltiples).             9) Validaciones duras     ref1 único en histórico (no duplicar). Montos positivos (2 decimales). Remanente ≥ 0 siempre. ROJO no paga: botones deshabilitados con tooltip (“Ref. no conciliada / inexistente / vencida”). Devolución a cliente: bank_json completo (cuenta, tipo, banco, titular = nombre). PDF: no incluir registros ROJO.             10) Estados automáticos y transiciones     Pendiente creado sin ref1 → ROJO. Pendiente con ref1 inexistente → ROJO. Import banco con ese ref1 → actualiza pendientes a GRIS (habilitados). Aplicaciones parciales → ref1 GRIS (remanente > 0). Aplicado 100% → ref1 VERDE. Aplazar → AZUL hasta fecha; al vencer regresa a GRIS/AMARILLO. >30 días sin clasificar → ROJO (si no tiene ningún match).             11) Interacciones clave con el resto del portal     Trámites (Pendientes): “Pagar aseguradora”: genera pendiente en Cheques; pide aseguradora + póliza si faltan. “Descontar a corredor”: crea adelanto y pendiente en Cheques ROJO → se habilita cuando se cierre quincena (asiento espejo). Cambio a “Transferencia recibida” exige ref1 y borra automáticamente el adelanto + pendiente de descuento, enchufando el flujo a Cheques normal. Pago directo: saca el caso de Cheques (elimina adelanto y pendiente).   Comisiones (Adelantos): Pago externo → abre “Registrar transferencia”, crea entrada en histórico con intención a ese adelanto (sugerido), se aplica en Cheques y solo al estar VERDE se considera pagado integralmente.             12) QA / Criterios de aceptación     Importa el archivo del banco respetando mapeo exacto de columnas y limpieza de Descripción. ref1 es la clave para match y habilitación (GRIS) de pendientes; sin ref1, ROJO salvo descuento de comisiones (GRIS especial). Split (1 ref → N pagos) y Merge (N ref → 1 pago) operan sin remanente negativo y cambian estados correctamente. Confirmar pagado: Con ref1: vincula al histórico y pasa a VERDE. Por descuento de comisiones: asiento espejo y VERDE, con Fecha = cierre de quincena, Referencia = “DESCUENTO COMISIONES”, Descripción = “Broker {nombre} — {Qx-MM-YYYY}”.   Cambios en Pendientes (transferencia recibida / pago directo / cambiar desde descontar a corredor) sincronizan automáticamente Cheques (crean/limpian pendientes/adelantos según reglas). Bloqueo ROJO efectivo: ningún pago puede marcarse como pagado mientras sea rojo (o mientras no exista el ref1). PDF correcto (branding, totales). Bitácora registra operaciones clave y el panel de Validaciones abiertas lista todos los rojos con acceso rápido a resolver.         Con este flujo operativo, Cheques queda sólido para:   Mantener una sola fuente de verdad (histórico bancario). Conciliar cada salida usando ref1. Coordinar correctamente con Comisiones (adelantos) y Pendientes (trámites), permitiendo cambios de decisión (transferencia vs. descuento vs. pago directo) sin inconsistencias.

## Progreso

- **2025-10-04 12:06** Auditoría iniciada. Se crea archivo de seguimiento.
- **2025-10-04 12:15** Etapa 1 completada: inventario de archivos clave (`src/app/(app)/checks/`, `src/components/checks/`, `src/lib/checks/`). Se identifican tabs `BankHistoryTab`, `PendingPaymentsTab`, wizard y acciones en `actions.ts`.
- **2025-10-04 12:25** Etapa 2 completada: revisión de esquema. Tablas relevantes detectadas: `check_batches`, `check_items` (legacy); nuevas `bank_transfers`, `pending_payments`, `payment_references`, `payment_details`. Revisados triggers `validate_payment_references`, `update_can_be_paid` y políticas RLS en `migrations/create_checks_tables.sql`.
- **2025-10-04 12:32** Etapa 3 en curso: auditoría de RLS y triggers. Se confirmaron políticas declaradas en migración `create_checks_tables.sql`; pendiente verificar su estado real en Supabase y la coexistencia con tablas legacy `check_*`.
- **2025-10-04 12:35** Corrección aplicada en `src/app/(app)/checks/actions.ts`: todas las server actions sensibles (`actionImportBankHistoryXLSX`, `actionCreatePendingPayment`, `actionMarkPaymentsAsPaidNew`) validan sesión con `getSupabaseServer()` antes de usar el cliente admin. Se corrige inserción de referencias (`payment_references`) tipando con `TablesInsert`.
- **2025-10-04 12:38** Etapa 4 en curso: revisión detallada de endpoints en `actions.ts` (`actionGetBankTransfers`, `actionGetPendingPaymentsNew`, `actionValidateReferences`, `actionApplyTransferToPayments`, etc.) para mapear huecos frente al flujo deseado.
- **2025-10-04 12:42** Ajustes a endpoints: en `actionImportBankHistoryXLSX` se evita escribir columnas generadas (`status`, `remaining_amount`). En `actionCreatePendingPayment`/`actionMarkPaymentsAsPaidNew` se dejan de recalcular estatus manualmente para respetar triggers/calculados.
- **2025-10-04 12:45** Se documenta deuda técnica: acciones legacy (`actionGetCheckHistory`, `actionImportBankHistory`, `actionApplyTransferToPayments`, `actionMarkPaymentsAsPaid`, `actionGetPendingPayments`) aún operan sobre `check_items` y pueden romper el flujo nuevo si algún componente las consume.
- **2025-10-04 12:51** Integración adelantos ↔ Cheques parcialmente implementada: `actionGetAdvanceDetails`, `RegisterPaymentWizard` y `ChecksMainClient` precargan y envían `advance_id`. Falta cerrar adelantos al aplicar pago (`actionMarkPaymentsAsPaidNew`) y mostrar badges en `PendingPaymentsTab`.
